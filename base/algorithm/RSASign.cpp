#include "RSASign.h"
#include <string.h>
#include "Base64.h"
#include <openssl/pem.h>
#include <openssl/ssl.h>
#include <openssl/rsa.h>
#include <openssl/evp.h>
#include <openssl/bio.h>
#include <openssl/err.h>
#include <openssl/md5.h>


//#pragma comment(lib, "libssl.lib")
//#pragma comment(lib, "libcrypto.lib")

CRSASign& CRSASign::GetInstance()
{
	static CRSASign sObj;
	return sObj;
}

std::string CRSASign::RSASign(const wchar_t* strText)
{
	//return RSASign(WChar2UTF8(strText).c_str());
	return "";
}

std::string CRSASign::RSASign(const char* strText)
{
	if (!m_pRSA || m_nSigLen < 1)
	{
		return "";
	}

	unsigned char md5[16];
	MD5((const unsigned char*)strText, strlen(strText), md5);

	unsigned char* sig = new unsigned char[m_nSigLen];
	unsigned int len;

	std::string strResult;

	char* pB64Buf = nullptr;

	do
	{
		if (!sig)
		{
			break;
		}

		if (1 != RSA_sign(NID_md5, md5, sizeof(md5), sig, &len, (RSA*)m_pRSA))
		{
			break;
		}

		int nNeedSize = CBase64::Base64Encode(sig, len, nullptr, 0);
		pB64Buf = new char[nNeedSize + 1];
		if (!pB64Buf)
		{
			break;
		}

		CBase64::Base64Encode(sig, len, (unsigned char*)pB64Buf, nNeedSize + 1);
	} while (false);

	if (sig)
	{
		delete []sig;
		sig = nullptr;
	}

	if (pB64Buf)
	{
		strResult = pB64Buf;
		delete pB64Buf;
		pB64Buf = nullptr;
	}
	
	return strResult;
}

CRSASign::CRSASign()
{
	//��Կ��MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1QRTKvqS0RO2fL9qZ+JZ9pIVmMlu6w5DKm709IG5KLrRqVJ33SiL/4vXWiFlctFWn1IHOJN55exOGUlHsf/eoUFcLwjpEI/uVU+lvwaaaqfIsKqXDlNkEkx03ntAZGiz0g/doI7GigzToOHUDOxvAIOeJXL5qaTOmGdesOZVC2pXYGKt7dyj3jcTNvkOxYBBKwI2wDwjjy5qc2sodTvzR9/bg3qVp7Nb9H+w2NdTzS4DIlOtN134hU4F6SEk0Iy1We8Ou7anSwPPLP+U2Xs5afWvoD/8jTNE/zNVRJc3zGtIIpbTAk5vVUyotCR/tJVnjPEnkg05kpZ929ziYBi9ywIDAQAB
	/*
-----BEGIN PRIVATE KEY-----
MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDVBFMq+pLRE7Z8
v2pn4ln2khWYyW7rDkMqbvT0gbkoutGpUnfdKIv/i9daIWVy0VafUgc4k3nl7E4Z
SUex/96hQVwvCOkQj+5VT6W/Bppqp8iwqpcOU2QSTHTee0BkaLPSD92gjsaKDNOg
4dQM7G8Ag54lcvmppM6YZ16w5lULaldgYq3t3KPeNxM2+Q7FgEErAjbAPCOPLmpz
ayh1O/NH39uDepWns1v0f7DY11PNLgMiU603XfiFTgXpISTQjLVZ7w67tqdLA88s
/5TZezlp9a+gP/yNM0T/M1VElzfMa0giltMCTm9VTKi0JH+0lWeM8SeSDTmSln3b
3OJgGL3LAgMBAAECggEBAMBdQnnKhLEYezCWb5HWv+VCMQyjw22zmIYGY2E2kK4u
X03oMmRezGZ+s4AqLoIMd4wyuGCoFWnEBxcgrQUaisLW0leLVWVmhRU3cvdaEDKG
yF55/yWpuvInZ1bOuOyz/MeTGlJ2/OYIBUkBBsyQ6wDs2vD4rms7cHICz2ky59QA
knHWmvnqrLILuhRK/yaEkKb6bQzOhEyaXn4LP+Zzm6ZCjvbSEiTQkSmIQtOtPp4l
Hn8Zte7K8H3lnnc39g83CIr6O7UkQwukescmZxMVAAXBjT6H9XNhYad7+LiJJKrG
DGPHuvjuTSh3URwR+zQ/P3XeUlhh6AcSVW1YcpWk0RkCgYEA+24e6LU3iiJuhH3C
CIDxh3n0RHQo0G4DP6bRAWH0447ZbPYrkBsjyhgKWPoLXnOflJ8RAC0mSUqQQxMo
9+hs0M2MJ6jd3rCNjEXpW2G3CXawN2kB5L8k86/Fgma+wWYxk9BIGkRucfrmM9FG
6fldOqVRtNdfNMu+Px7QF91nT2cCgYEA2ON4mFLu0qTgsq1x2sa9simsLPJPEsTZ
eESxqHMwxFrKsMME4s1ij/Y5VCr6cI2iDLgpRqxXHf2ZUQ1wS5Hl+Xd+rJPOGCWJ
CWv9MzpwKsPVsDSf7KWy+XedeSbyvmcuviDZNKqT0gQrAgGRa0vpeRYN7kyITn0i
r5gJYOSMc/0CgYBZSTTOvLO5aRrIEAScknWy/3rf6EQqKDcdHncwP4IAYVUS3aSA
qzKdbMYX7MumwfaUh5w47M+gzUrHlwFAcBhcWfIAj3Yiw52wh48j9WJTiQNw2ehj
PAG6S9wev6/T7B+E9zzznwN9lHS1SAcfxX72+Yg3aRgVHpkzvxR0tRof1wKBgQCU
oByN1ZcPBilsh+rTjwmDQ4dXLZz+MaMNBZXw5y7t/4GSa7G3ciMun/5dLS59XrFD
ohe29HameJhNsLXZM1uy/i3yOT8r0Nz9deEG7+7Zf2W53/YPhuUEivGAii4iSDcB
1yTBMHsnme+W6lgqfNS7Q1+8gvmNP7c7OSaEHVoaSQKBgQCk9VkKqyqXg529xrFl
3rbCcv8I6K3wHmeC0ucTkRK/b6KeNVK7t0G1Ou54cgGuycvta2TPwY20GK1vmsez
e1SeER9C0dZzK1L7jUjg1W4pHtKx1Oarx3n/lcdpdJpI+ueC/i51YqYCn2xbVX11
G0sAXeftJdX0DyJdVleR2tibnw==
-----END PRIVATE KEY-----	
	*/

	m_nSigLen = 0;
	m_pRSA = nullptr;
	char pPrivKeyStr[] = { 45,45,45,45,45,66,69,71,73,78,32,80,82,73,86,65,84,69,32,75,69,89,45,45,45,45,45,10,77,73,73,69,118,119,73,66,65,68,65,78,66,103,107,113,104,107,105,71,57,119,48,66,65,81,69,70,65,65,83,67,66,75,107,119,103,103,83,108,65,103,69,65,65,111,73,66,65,81,68,86,66,70,77,113,43,112,76,82,69,55,90,56,10,118,50,112,110,52,108,110,50,107,104,87,89,121,87,55,114,68,107,77,113,98,118,84,48,103,98,107,111,117,116,71,112,85,110,102,100,75,73,118,47,105,57,100,97,73,87,86,121,48,86,97,102,85,103,99,52,107,51,110,108,55,69,52,90,10,83,85,101,120,47,57,54,104,81,86,119,118,67,79,107,81,106,43,53,86,84,54,87,47,66,112,112,113,112,56,105,119,113,112,99,79,85,50,81,83,84,72,84,101,101,48,66,107,97,76,80,83,68,57,50,103,106,115,97,75,68,78,79,103,10,52,100,81,77,55,71,56,65,103,53,52,108,99,118,109,112,112,77,54,89,90,49,54,119,53,108,85,76,97,108,100,103,89,113,51,116,51,75,80,101,78,120,77,50,43,81,55,70,103,69,69,114,65,106,98,65,80,67,79,80,76,109,112,122,10,97,121,104,49,79,47,78,72,51,57,117,68,101,112,87,110,115,49,118,48,102,55,68,89,49,49,80,78,76,103,77,105,85,54,48,51,88,102,105,70,84,103,88,112,73,83,84,81,106,76,86,90,55,119,54,55,116,113,100,76,65,56,56,115,10,47,53,84,90,101,122,108,112,57,97,43,103,80,47,121,78,77,48,84,47,77,49,86,69,108,122,102,77,97,48,103,105,108,116,77,67,84,109,57,86,84,75,105,48,74,72,43,48,108,87,101,77,56,83,101,83,68,84,109,83,108,110,51,98,10,51,79,74,103,71,76,51,76,65,103,77,66,65,65,69,67,103,103,69,66,65,77,66,100,81,110,110,75,104,76,69,89,101,122,67,87,98,53,72,87,118,43,86,67,77,81,121,106,119,50,50,122,109,73,89,71,89,50,69,50,107,75,52,117,10,88,48,51,111,77,109,82,101,122,71,90,43,115,52,65,113,76,111,73,77,100,52,119,121,117,71,67,111,70,87,110,69,66,120,99,103,114,81,85,97,105,115,76,87,48,108,101,76,86,87,86,109,104,82,85,51,99,118,100,97,69,68,75,71,10,121,70,53,53,47,121,87,112,117,118,73,110,90,49,98,79,117,79,121,122,47,77,101,84,71,108,74,50,47,79,89,73,66,85,107,66,66,115,121,81,54,119,68,115,50,118,68,52,114,109,115,55,99,72,73,67,122,50,107,121,53,57,81,65,10,107,110,72,87,109,118,110,113,114,76,73,76,117,104,82,75,47,121,97,69,107,75,98,54,98,81,122,79,104,69,121,97,88,110,52,76,80,43,90,122,109,54,90,67,106,118,98,83,69,105,84,81,107,83,109,73,81,116,79,116,80,112,52,108,10,72,110,56,90,116,101,55,75,56,72,51,108,110,110,99,51,57,103,56,51,67,73,114,54,79,55,85,107,81,119,117,107,101,115,99,109,90,120,77,86,65,65,88,66,106,84,54,72,57,88,78,104,89,97,100,55,43,76,105,74,74,75,114,71,10,68,71,80,72,117,118,106,117,84,83,104,51,85,82,119,82,43,122,81,47,80,51,88,101,85,108,104,104,54,65,99,83,86,87,49,89,99,112,87,107,48,82,107,67,103,89,69,65,43,50,52,101,54,76,85,51,105,105,74,117,104,72,51,67,10,67,73,68,120,104,51,110,48,82,72,81,111,48,71,52,68,80,54,98,82,65,87,72,48,52,52,55,90,98,80,89,114,107,66,115,106,121,104,103,75,87,80,111,76,88,110,79,102,108,74,56,82,65,67,48,109,83,85,113,81,81,120,77,111,10,57,43,104,115,48,77,50,77,74,54,106,100,51,114,67,78,106,69,88,112,87,50,71,51,67,88,97,119,78,50,107,66,53,76,56,107,56,54,47,70,103,109,97,43,119,87,89,120,107,57,66,73,71,107,82,117,99,102,114,109,77,57,70,71,10,54,102,108,100,79,113,86,82,116,78,100,102,78,77,117,43,80,120,55,81,70,57,49,110,84,50,99,67,103,89,69,65,50,79,78,52,109,70,76,117,48,113,84,103,115,113,49,120,50,115,97,57,115,105,109,115,76,80,74,80,69,115,84,90,10,101,69,83,120,113,72,77,119,120,70,114,75,115,77,77,69,52,115,49,105,106,47,89,53,86,67,114,54,99,73,50,105,68,76,103,112,82,113,120,88,72,102,50,90,85,81,49,119,83,53,72,108,43,88,100,43,114,74,80,79,71,67,87,74,10,67,87,118,57,77,122,112,119,75,115,80,86,115,68,83,102,55,75,87,121,43,88,101,100,101,83,98,121,118,109,99,117,118,105,68,90,78,75,113,84,48,103,81,114,65,103,71,82,97,48,118,112,101,82,89,78,55,107,121,73,84,110,48,105,10,114,53,103,74,89,79,83,77,99,47,48,67,103,89,66,90,83,84,84,79,118,76,79,53,97,82,114,73,69,65,83,99,107,110,87,121,47,51,114,102,54,69,81,113,75,68,99,100,72,110,99,119,80,52,73,65,89,86,85,83,51,97,83,65,10,113,122,75,100,98,77,89,88,55,77,117,109,119,102,97,85,104,53,119,52,55,77,43,103,122,85,114,72,108,119,70,65,99,66,104,99,87,102,73,65,106,51,89,105,119,53,50,119,104,52,56,106,57,87,74,84,105,81,78,119,50,101,104,106,10,80,65,71,54,83,57,119,101,118,54,47,84,55,66,43,69,57,122,122,122,110,119,78,57,108,72,83,49,83,65,99,102,120,88,55,50,43,89,103,51,97,82,103,86,72,112,107,122,118,120,82,48,116,82,111,102,49,119,75,66,103,81,67,85,10,111,66,121,78,49,90,99,80,66,105,108,115,104,43,114,84,106,119,109,68,81,52,100,88,76,90,122,43,77,97,77,78,66,90,88,119,53,121,55,116,47,52,71,83,97,55,71,51,99,105,77,117,110,47,53,100,76,83,53,57,88,114,70,68,10,111,104,101,50,57,72,97,109,101,74,104,78,115,76,88,90,77,49,117,121,47,105,51,121,79,84,56,114,48,78,122,57,100,101,69,71,55,43,55,90,102,50,87,53,51,47,89,80,104,117,85,69,105,118,71,65,105,105,52,105,83,68,99,66,10,49,121,84,66,77,72,115,110,109,101,43,87,54,108,103,113,102,78,83,55,81,49,43,56,103,118,109,78,80,55,99,55,79,83,97,69,72,86,111,97,83,81,75,66,103,81,67,107,57,86,107,75,113,121,113,88,103,53,50,57,120,114,70,108,10,51,114,98,67,99,118,56,73,54,75,51,119,72,109,101,67,48,117,99,84,107,82,75,47,98,54,75,101,78,86,75,55,116,48,71,49,79,117,53,52,99,103,71,117,121,99,118,116,97,50,84,80,119,89,50,48,71,75,49,118,109,115,101,122,10,101,49,83,101,69,82,57,67,48,100,90,122,75,49,76,55,106,85,106,103,49,87,52,112,72,116,75,120,49,79,97,114,120,51,110,47,108,99,100,112,100,74,112,73,43,117,101,67,47,105,53,49,89,113,89,67,110,50,120,98,86,88,49,49,10,71,48,115,65,88,101,102,116,74,100,88,48,68,121,74,100,86,108,101,82,50,116,105,98,110,119,61,61,10,45,45,45,45,45,69,78,68,32,80,82,73,86,65,84,69,32,75,69,89,45,45,45,45,45,0 };

	BIO* in = BIO_new_mem_buf((void*)pPrivKeyStr, -1);
	do
	{
		if (!in)
			break;

		m_pRSA = PEM_read_bio_RSAPrivateKey(in, nullptr, nullptr, nullptr);

		if (!m_pRSA)
		{
			break;
		}

		m_nSigLen = RSA_size((RSA*)m_pRSA);

	} while (false);

	if (in)
		BIO_free(in);
}

CRSASign::~CRSASign()
{
	if (m_pRSA)
	{
		RSA_free((RSA*)m_pRSA);
		m_pRSA = nullptr;
	}

}
